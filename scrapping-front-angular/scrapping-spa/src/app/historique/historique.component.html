<div class="card shadow-sm mb-3">
  <div class="card-header"><strong>Filtres</strong></div>
  <div class="card-body">
    <div class="row g-3">
      
      <!-- Query -->
      <div class="col-md-4">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Code NAF / Query</mat-label>
          <input
            type="text"
            matInput
            [formControl]="nafControl"
            [matAutocomplete]="nafAuto"
            placeholder="Ex: Restaurants"
          >
          <mat-autocomplete #nafAuto="matAutocomplete">
            <mat-option *ngFor="let n of filteredNaf | async" [value]="n.label">
              {{ n.id }} - {{ n.label }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        
      </div>

      <!-- Location -->
      <div class="col-md-4">
        <mat-form-field class="w-100" appearance="outline">
          <mat-label>Location</mat-label>
          <input
            type="text"
            matInput
            [formControl]="locationControl"
            [matAutocomplete]="auto"
            placeholder="Tapez au moins 2 lettres"
          >
          <mat-autocomplete #auto="matAutocomplete">
            <mat-option *ngFor="let option of filteredOptions | async" [value]="option">
              {{ option }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>

      <!-- Source -->
      <div class="col-md-4">
        <mat-label class="d-block mb-2">Source</mat-label>
        <mat-radio-group [(ngModel)]="filterSource" aria-label="Source">
          <mat-radio-button value="">Tous</mat-radio-button>
          <mat-radio-button value="gmaps">Google Maps</mat-radio-button>
          <mat-radio-button value="pagesjaunes">PagesJaunes.fr</mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Dates -->
      <div class="col-md-6 d-flex gap-3">
        <mat-form-field class="flex-fill" appearance="outline">
          <mat-label>Date Scraping - De</mat-label>
          <input matInput [matDatepicker]="pickerFrom" [(ngModel)]="dateFrom">
          <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
          <mat-datepicker #pickerFrom></mat-datepicker>
        </mat-form-field>

        <mat-form-field class="flex-fill" appearance="outline">
          <mat-label>Date Scraping - À</mat-label>
          <input matInput [matDatepicker]="pickerTo" [(ngModel)]="dateTo">
          <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
          <mat-datepicker #pickerTo></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Boutons -->
      <div class="col-auto ms-auto d-flex gap-2">
        <button mat-raised-button color="primary" (click)="applyFilters()">
           Appliquer
        </button>
        <button mat-stroked-button color="warn" (click)="resetFilters()">
           Réinitialiser
        </button>
        <button mat-raised-button color="accent" (click)="exportCSV()">
           Exporter CSV
        </button>
      </div>

    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div><strong>Historique</strong> — Page {{ page }} / {{ totalPages || 1 }}</div>
    <div class="text-muted small">Total : <span class="badge bg-primary">{{ total }}</span></div>
  </div>
  <div class="card-body">

    <div *ngIf="rows?.length; else empty">
      <table mat-table [dataSource]="rows" matSort class="mat-elevation-z1 table-responsive">

        <!-- ID -->
        <ng-container matColumnDef="history_id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
          <td mat-cell *matCellDef="let row">{{ row.history_id }}</td>
        </ng-container>

        <!-- Date Scraping -->
        <ng-container matColumnDef="scraped_at">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Date Scraping</th>
          <td mat-cell *matCellDef="let row">{{ formatFRDate(row.scraped_at) }}</td>
        </ng-container>

        <!-- Query -->
        <ng-container matColumnDef="query">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Query</th>
          <td mat-cell *matCellDef="let row">{{ row.query }}</td>
        </ng-container>

        <!-- Location -->
        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Location</th>
          <td mat-cell *matCellDef="let row">{{ row.location }}</td>
        </ng-container>

        <!-- Source -->
        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Source</th>
          <td mat-cell *matCellDef="let row">{{ row.source }}</td>
        </ng-container>

        <!-- Nom -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
          <td mat-cell *matCellDef="let row">{{ row.name }}</td>
        </ng-container>

        <!-- Adresse -->
        <ng-container matColumnDef="address">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Adresse</th>
          <td mat-cell *matCellDef="let row">{{ row.address }}</td>
        </ng-container>

        <!-- Téléphone -->
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Téléphone</th>
          <td mat-cell *matCellDef="let row">{{ row.phone }}</td>
        </ng-container>

        <!-- Site Web -->
        <ng-container matColumnDef="website">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Site Web</th>
          <td mat-cell *matCellDef="let row">{{ row.website }}</td>
        </ng-container>

        <!-- Plus Code -->
        <ng-container matColumnDef="plus_code">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Plus Code</th>
          <td mat-cell *matCellDef="let row">{{ row.plus_code }}</td>
        </ng-container>

        <!-- Note -->
        <ng-container matColumnDef="note">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Note</th>
          <td mat-cell *matCellDef="let row">{{ row.note }}</td>
        </ng-container>

        <!-- Horaires -->
        <ng-container matColumnDef="horaires">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Horaires</th>
          <td mat-cell *matCellDef="let row">{{ row.horaires }}</td>
        </ng-container>

        <!-- Header and Row Declarations -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>

      <!-- Paginator -->
      <mat-paginator [length]="total" [pageSize]="perPage" [pageSizeOptions]="[5,10,25,50]" showFirstLastButtons (page)="onPageChange($event)">
      </mat-paginator>
    </div>

    <ng-template #empty>
      <div class="text-muted">Aucune donnée</div>
    </ng-template>
  </div>
</div>
