<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Scrapping Tels</title>
	<link rel="icon"
		href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
		crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

</head>

<body>


	<div class="container-fluid py-4">
		<div class="row justify-content-center">
			<div class="col-12 col-xl-10">
				<!-- Header Card -->
				<div class="card border-0 shadow-lg mb-4">
					<div class="card-header bg-primary text-white py-3">
						<h1 class="h4 mb-0">Scraping entreprises France</h1>
					</div>
					<div class="card-body p-4">
						<form id="scrapingForm">
							<div class="row g-3 mb-4">
								<div class="col-md-3">
									<label for="codeNafSecteur" class="form-label fw-bold">Code NAF / Secteur</label>
									<div class="input-group position-relative">
										<span class="input-group-text">
											<i class="bi bi-building"></i>
										</span>
										<input type="text" id="codeNafSecteur" name="query"
											class="form-control form-control-lg" placeholder="Ex : Restaurants">
										<!-- Container pour les suggestions -->
										<div id="autocomplete-list" class="autocomplete-items position-absolute w-100">
										</div>
									</div>
								</div>
								<div class="col-md-3">
									<label for="region" class="form-label fw-bold">Région</label>
									<div class="input-group">
										<span class="input-group-text">
											<i class="bi bi-map"></i>
										</span>
										<select id="region" name="region" class="form-select form-select-lg py-3">
											<option value="">Sélectionnez une région</option>

										</select>
									</div>
								</div>
								<div class="col-md-3">
									<label for="departement" class="form-label fw-bold">Département</label>
									<div class="input-group">
										<span class="input-group-text">
											<i class="bi bi-geo-alt"></i>
										</span>
										<select id="departement" name="departement"
											class="form-select form-select-lg py-3">
											<option value="">Sélectionnez un département</option>

										</select>
									</div>
								</div>
								<div class="col-md-3">
									<label for="ville" class="form-label fw-bold">Ville</label>
									<div class="input-group position-relative">
										<span class="input-group-text">
											<i class="bi bi-pin-map"></i>
										</span>
										<input type="text" id="ville" name="ville" class="form-control form-control-lg"
											placeholder="Tapez le nom de la ville">
										<div id="ville-autocomplete" class="autocomplete-items position-absolute w-100">
										</div>
									</div>
								</div>
							</div>

							<div class="mb-4">
								<label class="form-label fw-bold">Source de données</label>
								<div class="d-flex flex-wrap gap-3">
									<div class="form-check card card-hover p-0 source-card">
										<input class="form-check-input d-none" type="radio" name="source"
											id="sourceGoogle" value="googlemaps" checked>
										<label class="form-check-label card-body d-flex align-items-center gap-2"
											for="sourceGoogle">
											<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Google_Maps_icon_%282020%29.svg/48px-Google_Maps_icon_%282020%29.svg.png"
												width="32" height="32" class="rounded">
											<span>Google Maps</span>
										</label>
									</div>
									<div class="form-check card card-hover p-0 source-card">
										<input class="form-check-input d-none" type="radio" name="source"
											id="sourcePagesJaunes" value="pagesjaunes">
										<label class="form-check-label card-body d-flex align-items-center gap-2"
											for="sourcePagesJaunes">
											<img src="https://www.pagesjaunes.fr/assets/images/logo_pagesjaunes-b41e5acdca.svg"
												width="32" height="32" class="rounded">
											<span>PagesJaunes.fr</span>
										</label>
									</div>
								</div>
							</div>

							<div class="row g-3 align-items-end">
								<div class="col-md-2">
									<label for="maxResults" class="form-label fw-bold">Nombre de résultats</label>
									<input type="number" id="maxResults" name="max_results"
										class="form-control form-control-lg" value="5" min="1" max="10">
								</div>
								<div class="col-md-10 d-flex justify-content-end align-items-center gap-3">
									<button type="button" id="resetBtn" class="btn btn-outline-secondary btn-lg px-4">
										<i class="bi bi-arrow-counterclockwise me-2"></i>Réinitialiser
									</button>
									<button type="submit" class="btn btn-primary btn-lg px-4 position-relative">
										<span id="btnSpinner" class="spinner-border spinner-border-sm me-2 d-none"
											role="status"></span>
										<i class="bi bi-search me-2"></i>Rechercher
									</button>
								</div>
							</div>
						</form>
					</div>
				</div>

				<!-- Results Section -->
				<div id="resultsSection" class="d-none">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h2 class="h5 text-muted mb-0">Résultats du scraping</h2>
						<div class="badge bg-primary rounded-pill" id="resultsCount"></div>
					</div>
					<div class="card border-0 shadow">
						<div class="card-body p-0">
							<div class="d-flex justify-content-end mb-3">
								<button id="exportBtn" class="btn btn-success">
									<i class="bi bi-file-earmark-excel me-2"></i>Exporter en CSV
								</button>
							</div>
							<div class="table-responsive">
								<div id="resultsContainer"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Loading Modal -->
	<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0 shadow">
				<div class="modal-body text-center p-4">
					<div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
					<h5 class="mb-1">Scraping en cours</h5>
					<p class="text-muted mb-0">Veuillez patienter pendant la collecte des données...</p>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

	<style>
		.autocomplete-items {
			position: absolute;
			/* positionné par rapport à l'input parent */
			top: 100%;
			/* juste en dessous de l'input */
			left: 0;
			right: 0;
			z-index: 1050;
			/* au-dessus des autres éléments Bootstrap */
			border: 1px solid #ced4da;
			border-top: none;
			background-color: #fff;
			max-height: 250px;
			overflow-y: auto;
			box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
			border-radius: 0 0 0.25rem 0.25rem;
		}

		/* Chaque élément de la liste */
		.autocomplete-item {
			padding: 0.5rem 1rem;
			cursor: pointer;
			font-size: 0.95rem;
			transition: background-color 0.2s;
		}

		.autocomplete-item:hover,
		.autocomplete-item.active {
			background-color: #0d6efd;
			color: #fff;
		}

		/* Pour éviter que le parent n'ait un overflow caché */
		.input-group.position-relative {
			z-index: 1000;
		}

		.autocomplete-match {
			font-weight: bold;
		}

		.card-hover {
			transition: all 0.2s ease;
			cursor: pointer;
			border: 1px solid #dee2e6;
		}

		.card-hover:hover {
			transform: translateY(-2px);
			box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
		}

		.form-check-input:checked+.card-hover {
			border-color: #0d6efd;
			background-color: rgba(13, 110, 253, 0.05);
		}

		.table {
			--bs-table-bg: transparent;
		}

		.table thead th {
			border-bottom-width: 1px;
			text-transform: uppercase;
			font-size: 0.75rem;
			letter-spacing: 0.5px;
		}

		.table-hover tbody tr {
			transition: all 0.2s ease;
		}

		.table-hover tbody tr:hover {
			background-color: rgba(13, 110, 253, 0.05) !important;
		}

		.source-card.active {
			border: 2px solid #0d6efd !important;
			background-color: rgba(13, 110, 253, 0.05) !important;
		}
	</style>


	<script>
		document.getElementById('exportBtn').addEventListener('click', function () {
			const results = [];

			document.querySelectorAll('#resultsContainer tbody tr').forEach(row => {
				const rawDate = row.children[8].textContent.trim();
				const dateObj = new Date(rawDate);
				const formattedDate = `${String(dateObj.getDate()).padStart(2, '0')}/` +
					`${String(dateObj.getMonth() + 1).padStart(2, '0')}/` +
					`${dateObj.getFullYear()} ` +
					`${String(dateObj.getHours()).padStart(2, '0')}:` +
					`${String(dateObj.getMinutes()).padStart(2, '0')}:` +
					`${String(dateObj.getSeconds()).padStart(2, '0')}`;
				const rowData = {
					Nom: row.children[0].textContent.trim(),
					Adresse: row.children[1].textContent.trim(),
					Téléphone: row.children[2].textContent.trim(),
					SiteWeb: row.children[3].textContent.trim(),
					Menu: row.children[4].textContent.trim(),
					PlusCode: row.children[5].textContent.trim(),
					Horaires: row.children[6].textContent.trim(),
					Note: row.children[7].textContent.trim(),
					ScrapeDate: formattedDate // garder tel quel ou formatter si nécessaire
				};
				results.push(rowData);
			});

			if (results.length === 0) {
				alert("Aucun résultat à exporter !");
				return;
			}

			// Créer le CSV avec BOM UTF-8
			const csvContent = "\uFEFF" + [
				Object.keys(results[0]).join(';'),
				...results.map(r => Object.values(r).map(v => `"${v.replace(/"/g, '""')}"`).join(';'))
			].join('\n');

			// Télécharger le CSV
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.setAttribute('download', 'resultats_scraping.csv');
			link.click();
		});

	</script>


	<script>
		const input = document.getElementById('codeNafSecteur');
		const listContainer = document.getElementById('autocomplete-list');

		input.addEventListener('input', async function () {
			listContainer.innerHTML = '';
			if (!this.value) return;

			// Charger le JSON depuis le répertoire public
			const response = await fetch('naf-activity.json');
			const data = await response.json();

			data.forEach(item => {
				const displayText = `${item.id} - ${item.label}`;
				const inputValue = input.value.trim().toLowerCase();

				if (displayText.toLowerCase().includes(inputValue)) {
					const itemDiv = document.createElement("DIV");
					// mettre en gras la partie correspondante
					const regex = new RegExp(`(${inputValue})`, 'gi');
					itemDiv.innerHTML = displayText.replace(regex, '<span class="autocomplete-match">$1</span>');

					itemDiv.classList.add('autocomplete-item');
					itemDiv.addEventListener("click", function () {
						input.value = item.label; // Seul le label est envoyé
						listContainer.innerHTML = '';
					});
					listContainer.appendChild(itemDiv);
				}
			});
		});

		// Fermer la liste si clic à l'extérieur
		document.addEventListener("click", function (e) {
			if (e.target !== input) listContainer.innerHTML = '';
		});
	</script>
	</script>
	<script>
		// Ajouter ce script pour gérer la sélection visuelle
		document.querySelectorAll('.source-card').forEach(card => {
			card.addEventListener('click', function () {
				document.querySelectorAll('.source-card').forEach(c => c.classList.remove('active'));
				this.classList.add('active');
				const radio = this.querySelector('input[type="radio"]');
				radio.checked = true;
			});
		});

		// Activer la première carte par défaut
		document.querySelector('.source-card').classList.add('active');

		// --- Gestion des selects pour ne choisir qu'une seule localisation ---
		const villeSelect = document.getElementById('ville');
		const departementSelect = document.getElementById('departement');
		const regionSelect = document.getElementById('region');

		function handleLocationChange(changedSelect) {
			if (changedSelect.value) {
				[villeSelect, departementSelect, regionSelect].forEach(s => {
					if (s !== changedSelect) s.disabled = true;
				});
			} else {
				[villeSelect, departementSelect, regionSelect].forEach(s => s.disabled = false);
			}
		}

		villeSelect.addEventListener('change', () => handleLocationChange(villeSelect));
		departementSelect.addEventListener('change', () => handleLocationChange(departementSelect));
		regionSelect.addEventListener('change', () => handleLocationChange(regionSelect));

		// --- Bouton Reset ---
		document.getElementById('resetBtn').addEventListener('click', function () {
			document.getElementById('scrapingForm').reset();
			[villeSelect, departementSelect, regionSelect].forEach(s => s.disabled = false);
			document.getElementById('resultsContainer').innerHTML = '';
			document.getElementById('resultsSection').classList.add('d-none');
		});

		// --- AJAX submit ---
		document.getElementById('scrapingForm').addEventListener('submit', function (e) {
			e.preventDefault();

			// const spinner = document.getElementById('btnSpinner');
			const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
			//spinner.classList.remove('d-none');
			loadingModal.show();

			const query = document.getElementById('codeNafSecteur').value || '';
			const region = regionSelect.value;
			const departement = departementSelect.value;
			const ville = villeSelect.value;
			const max_results = Math.min(10, Math.max(1, parseInt(document.getElementById('maxResults').value || 5)));

			const location = ville || departement || region;
			const source = document.querySelector('input[name="source"]:checked').value;
			const apiUrl = source === 'googlemaps' ? 'http://localhost:9000/scrape/googlemaps' : 'http://localhost:9000/scrape/pagesjaunes';

			const payload = { query, location, max_results };

			fetch(apiUrl, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			})
				.then(resp => resp.json())
				.then(json => {
					//spinner.classList.add('d-none');
					loadingModal.hide();

					const resultsSection = document.getElementById('resultsSection');
					resultsSection.classList.remove('d-none');

					if (json.status === 'success' && json.results.length > 0) {
						document.getElementById('resultsCount').textContent = `${json.results.length} résultat(s)`;

						let html = `<table class="table table-hover align-middle">
			                <thead>
			                    <tr class="bg-light">
			                        <th width="15%">Nom</th>
			                        <th width="20%">Adresse</th>
			                        <th width="10%">Téléphone</th>
			                        <th width="15%">Site Web</th>
			                        <th width="10%">Menu</th>
			                        <th width="10%">Plus Code</th>
			                        <th width="10%">Horaires</th>
			                        <th width="5%">Note</th>
			                        <th width="5%">Scrapé à</th>
			                    </tr>
			                </thead>
			                <tbody>`;

						json.results.forEach(r => {
							const website = r['Site Web'] ? `<a href="${r['Site Web'].startsWith('http') ? r['Site Web'] : 'https://' + r['Site Web']}" target="_blank" class="text-decoration-none">${r['Site Web']} <i class="bi bi-box-arrow-up-right"></i></a>` : 'N/A';
							const phone = r.Téléphone
								? r.Téléphone.split(',')             // découpe la chaîne sur les virgules
									.map(num => `<a href="tel:${num.trim()}" class="text-decoration-none">${num.trim()}</a>`) // met chaque numéro dans un lien
									.join('<br>')                    // sépare chaque numéro par un saut de ligne
								: 'N/A';

							html += `<tr>
			                    <td class="fw-bold">${r.Nom || 'N/A'}</td>
			                    <td>${r.Adresse || 'N/A'}</td>
			                    <td>${phone}</td>
			                    <td>${website}</td>
			                    <td>${r.Menu || 'N/A'}</td>
			                    <td><span class="badge bg-light text-dark">${r['Plus Code'] || 'N/A'}</span></td>
			                    <td><small>${r.Horaires || 'N/A'}</small></td>
			                    <td>${r.Note ? `<span class="badge bg-success">${r.Note}</span>` : 'N/A'}</td>
			                    <td><small class="text-muted">${r['Heure de scraping'] || 'N/A'}</small></td>
			                </tr>`;
						});

						html += `</tbody></table>`;
						document.getElementById('resultsContainer').innerHTML = html;
					} else {
						document.getElementById('resultsContainer').innerHTML = `
			                <div class="text-center py-5">
			                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
			                    <h5 class="mt-3">Aucun résultat trouvé</h5>
			                    <p class="text-muted">Essayez de modifier vos critères de recherche</p>
			                </div>`;
					}
				})
				.catch(err => {
					spinner.classList.add('d-none');
					loadingModal.hide();
					document.getElementById('resultsContainer').innerHTML = `
			            <div class="alert alert-danger d-flex align-items-center">
			                <i class="bi bi-exclamation-octagon-fill me-2"></i>
			                <div>Une erreur est survenue lors du scraping : ${err.message || err}</div>
			            </div>`;
				});
		});
	</script>
	<script>
		async function chargerSelectOptions() {
			// Charger régions
			const regionSelect = document.getElementById('region');
			const regResp = await fetch('reg_names.json');
			const regData = await regResp.json();

			regData.forEach(region => {
				const opt = document.createElement('option');
				opt.value = region;
				opt.textContent = region;
				regionSelect.appendChild(opt);
			});

			// Charger départements
			const depSelect = document.getElementById('departement');
			const depResp = await fetch('dep_names.json');
			const depData = await depResp.json();

			depData.forEach(dep => {
				const opt = document.createElement('option');
				opt.value = dep;
				opt.textContent = dep;
				depSelect.appendChild(opt);
			});
		}

		// Lancer le chargement après que la page soit prête
		document.addEventListener('DOMContentLoaded', chargerSelectOptions);
	</script>
	<script>
		let franceData = null;

		async function loadFranceData() {
			if (!franceData) {
				const resp = await fetch('france.json');
				franceData = await resp.json();
			}
		}

		const villeInput = document.getElementById('ville');
		const villeList = document.getElementById('ville-autocomplete');

		villeInput.addEventListener('input', async function () {
			const query = this.value.trim().toLowerCase();
			villeList.innerHTML = '';

			if (query.length < 2) return; // éviter de lancer sur 1 lettre

			await loadFranceData();

			const results = franceData
				.filter(v => v.Nom_commune && v.Nom_commune.toLowerCase().includes(query))
				.slice(0, 30); // limiter à 30 suggestions max

			results.forEach(ville => {
				const div = document.createElement('div');
				div.classList.add('autocomplete-item');
				div.textContent = ville.Nom_commune;
				div.addEventListener('click', () => {
					villeInput.value = ville.Nom_commune;
					villeList.innerHTML = '';
				});
				villeList.appendChild(div);
			});
		});

		// Fermer si clic à l’extérieur
		document.addEventListener('click', (e) => {
			if (e.target !== villeInput) villeList.innerHTML = '';
		});
	</script>

</body>

</html>